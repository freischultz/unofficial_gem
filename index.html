<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boss Hunt Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Rajdhani:wght@600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        mono: ['Rajdhani', 'monospace'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            dark: 'rgba(15, 23, 42, 0.6)',
                            darker: 'rgba(10, 15, 30, 0.8)',
                        },
                        accent: {
                            gold: '#fbbf24',
                            blue: '#38bdf8',
                            green: '#4ade80',
                            red: '#f87171'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
            transition: background-image 0.8s ease-in-out;
            min-height: 100vh;
            color: #e2e8f0;
        }

        /* Dark Overlay */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.7));
            z-index: -1;
        }

        /* Glassmorphism Utility Classes */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Custom Inputs */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* Switches */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #38bdf8;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Timer Digits */
        .digit-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Status Animations */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background-color: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-offline {
            background-color: #f87171;
            box-shadow: 0 0 10px #f87171;
        }

        .status-checking {
            background-color: #fbbf24;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="antialiased p-4 sm:p-6">

    <div class="max-w-[1600px] mx-auto">

        <!-- Navbar / Header -->
        <header
            class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8 glass-panel rounded-2xl p-4 md:px-8">
            <!-- Logo Section -->
            <div class="flex items-center gap-4">
                <img src="https://gem.playpark.com/wp-content/uploads/2024/11/1-gem-logo.png" alt="Granado Espada M"
                    class="h-16 object-contain drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]"
                    onerror="this.onerror=null;this.src='https://i.imgur.com/kSTiS9s.png';">
                <div class="hidden sm:block border-l border-white/10 pl-4">
                    <h1 class="text-xl font-bold text-white tracking-wide">UNOFFICIAL TRACKER</h1>
                    <p class="text-xs text-accent-blue font-medium tracking-wider uppercase">Live Timer & Status</p>
                </div>
            </div>

            <!-- Server Status Pill -->
            <div id="server-status-container" class="flex flex-wrap items-center gap-3 bg-black/20 rounded-xl p-2">
                <!-- Injected via JS -->
            </div>
        </header>

        <!-- Global Controls Bar -->
        <div
            class="flex flex-wrap justify-center md:justify-between items-center gap-4 mb-8 glass-panel rounded-xl p-3">
            <div class="flex items-center gap-6 px-4">
                <!-- Notifications Toggle -->
                <button id="notifications-btn"
                    class="flex items-center gap-2 text-sm font-medium transition-colors hover:text-white group">
                    <div class="p-1.5 rounded-full bg-white/5 group-hover:bg-white/10 transition-colors">
                        <i class="ph-duotone ph-bell-ringing text-lg"></i>
                    </div>
                    <span id="notif-text">Enable Alerts</span>
                </button>

                <!-- Audio Duration -->
                <div class="flex items-center gap-2 text-sm font-medium text-gray-400">
                    <i class="ph-duotone ph-speaker-high text-lg"></i>
                    <select id="sound-duration"
                        class="bg-black/20 border border-white/10 rounded-lg px-2 py-1 text-xs text-white focus:outline-none focus:border-accent-blue transition-colors custom-select pr-8">
                        <option value="5">Short (5s)</option>
                        <option value="15" selected>Medium (15s)</option>
                        <option value="30">Long (30s)</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-3 px-2">
                <button id="swap-wallpaper-btn"
                    class="flex items-center gap-2 bg-white/5 hover:bg-white/10 border border-white/5 text-gray-200 px-4 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide transition-all">
                    <i class="ph-duotone ph-image"></i> Wallpaper
                </button>
                <a href="https://freischultz.github.io/unofficial_gem/wiki.html"
                    class="flex items-center gap-2 bg-accent-blue/10 hover:bg-accent-blue/20 border border-accent-blue/20 text-accent-blue px-4 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide transition-all">
                    <i class="ph-duotone ph-book-open-text"></i> Wiki
                </a>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Left Sidebar (3 Cols) -->
            <div class="lg:col-span-3 space-y-6">

                <!-- Patch Notes Highlight -->
                <div class="glass-card rounded-xl overflow-hidden group relative">
                    <div
                        class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent z-10 pointer-events-none">
                    </div>
                    <img src="https://gem.playpark.com/wp-content/uploads/2025/11/GEM-18-Nov-2025-Patchnotes.png"
                        alt="Patch Notes"
                        class="w-full h-48 object-cover transition-transform duration-700 group-hover:scale-110">
                    <div class="absolute bottom-0 left-0 right-0 p-4 z-20">
                        <span
                            class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-accent-blue text-black mb-2">UPDATE</span>
                        <h3 class="text-lg font-bold text-white leading-tight mb-1">Katovic Update</h3>
                        <a href="https://gem.playpark.com/en-sea/gem-patch-updates-18-november-2025-katovik-update/"
                            target="_blank"
                            class="text-xs text-gray-300 hover:text-white flex items-center gap-1 transition-colors">
                            Read Patch Notes <i class="ph-bold ph-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Resets Panel -->
                <div class="glass-card rounded-xl p-5">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="ph-duotone ph-clock-clockwise text-accent-gold"></i> Server Resets
                    </h2>
                    <div id="resets-container" class="space-y-4">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Audio Config -->
                <div class="glass-card rounded-xl p-5">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="ph-duotone ph-sliders-horizontal text-accent-blue"></i> Alert Config
                    </h2>
                    <div id="boss-settings-container" class="space-y-1 max-h-[300px] overflow-y-auto pr-2">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Main Content (9 Cols) -->
            <div class="lg:col-span-9">
                <div id="boss-timers-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                    <!-- Boss Cards Injected via JS -->
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 mb-6">
            <div
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/30 border border-white/5 text-xs text-gray-500">
                <span class="relative flex h-2 w-2">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                System Synchronized
            </div>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- BACKGROUNDS ---
            const backgrounds = [
                'https://gem.hanbiton.com/Brand2E/src/images/new-contents/event/bg.jpg',
                'https://gem.hanbiton.com/Brand2E/src/images/media/gallery-image-04-03.jpg',
                'https://gem.hanbiton.com/Brand2E/src/images/media/gallery-image-01-03.jpg',
                'https://gem.hanbiton.com/Brand2E/src/images/media/gallery-image-02-01.jpg',
                'https://gem.hanbiton.com/Brand2E/src/images/media/gallery-image-02-03.jpg',
                'https://gem.hanbiton.com/Brand2E/src/images/media/gallery-image-03-01.jpg'
            ];
            let currentBgIndex = 0;

            function setBackground(index) {
                // Use a high-quality overlay approach
                document.body.style.backgroundImage = `url(${backgrounds[index]})`;
            }
            setBackground(0);

            function swapWallpaper() {
                currentBgIndex = (currentBgIndex + 1) % backgrounds.length;
                setBackground(currentBgIndex);
            }

            // --- DATA & CONFIG ---
            // Kept exactly the same as original for compatibility
            const bosses = [
                { id: 'reboldeaux', name: 'Reboldeaux', full_name: 'Reboldeaux Boss', icon: '<i class="ph-duotone ph-sword"></i>', color: 'text-red-400', bg: 'bg-red-500/10', respawnInterval: 30 * 60 * 1000 },
                { id: 'coimbra', name: 'Coimbra', full_name: 'Coimbra Hunt', icon: '<i class="ph-duotone ph-lightning"></i>', color: 'text-yellow-400', bg: 'bg-yellow-500/10', respawnInterval: 10 * 60 * 60 * 1000 },
                { id: 'auch', name: 'Auch', full_name: 'Auch Hunt', icon: '<i class="ph-duotone ph-crown"></i>', color: 'text-purple-400', bg: 'bg-purple-500/10', respawnInterval: 21 * 60 * 60 * 1000 },
                { id: 'los-toldos', name: 'Los Toldos', full_name: 'Los Toldos', icon: '<i class="ph-duotone ph-cactus"></i>', color: 'text-green-400', bg: 'bg-green-500/10', respawnInterval: 21 * 60 * 60 * 1000 },
                { id: 'ustiur', name: 'Ustiur', full_name: 'Ustiur Map', icon: '<i class="ph-duotone ph-tree-palm"></i>', color: 'text-orange-400', bg: 'bg-orange-500/10', respawnInterval: 21 * 60 * 60 * 1000 },
                { id: 'katovic', name: 'Katovic', full_name: 'Katovic Snowfield', icon: '<i class="ph-duotone ph-snowflake"></i>', color: 'text-cyan-400', bg: 'bg-cyan-500/10', respawnInterval: 21 * 60 * 60 * 1000 }
            ];
            const servers = [
                { id: 'felipe', name: 'Felipe', ip: '121.52.205.22', port: 31001 },
                { id: 'montoro', name: 'Montoro', ip: '121.52.205.15', port: 30022 }
            ];
            const dailyResets = [
                { id: 'trade', name: 'Trade & Market' }, { id: 'mission', name: 'Daily Missions' }, { id: 'dungeon', name: 'Bounty Hunter' }, { id: 'cash-shop', name: 'Cash Shop Deals' }
            ];
            const weeklyResets = [{ id: 'raid', name: 'Raid Admission (x4)' }];
            const soundStyles = {
                classic: { name: 'Classic', synth: new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination() },
                electric: { name: 'Electric', synth: new Tone.FMSynth({ oscillator: { type: 'sawtooth' } }).toDestination() },
                roar: { name: 'Roar', synth: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.5, decay: 0.2, sustain: 0.1, release: 0.5 } }).toDestination() }
            };

            let state = {};
            let notifiedFor = {};

            // --- LOCAL STORAGE & STATE MANAGEMENT ---
            function loadState() {
                const savedState = localStorage.getItem('bossTrackerState');
                const now = Date.now();
                if (savedState) {
                    state = JSON.parse(savedState);
                    bosses.forEach(boss => {
                        if (state.bosses[boss.id]) {
                            let nextRespawn = state.bosses[boss.id].nextRespawn || 0;
                            while (nextRespawn < now) { nextRespawn += boss.respawnInterval; }
                            state.bosses[boss.id].nextRespawn = nextRespawn;
                        }
                    });
                } else {
                    state = { notificationsEnabled: false, soundDuration: 15, bosses: {} };
                    bosses.forEach(boss => {
                        let nextRespawn;
                        if (boss.id === 'coimbra') {
                            const spawnTime = new Date();
                            spawnTime.setHours(14, 0, 0, 0);
                            nextRespawn = spawnTime.getTime();
                        } else if (['auch', 'los-toldos', 'ustiur', 'katovic'].includes(boss.id)) {
                            const spawnTime = new Date();
                            spawnTime.setDate(spawnTime.getDate() + 1);
                            spawnTime.setHours(3, 0, 0, 0);
                            nextRespawn = spawnTime.getTime();
                        } else {
                            nextRespawn = Math.ceil(now / boss.respawnInterval) * boss.respawnInterval;
                        }
                        state.bosses[boss.id] = { warningTime: 5 * 60 * 1000, soundStyle: 'classic', muted: false, nextRespawn: nextRespawn };
                    });
                }
                // Ensure all bosses exist in state
                bosses.forEach(boss => {
                    if (!state.bosses[boss.id]) {
                        const nextRespawn = Math.ceil(now / boss.respawnInterval) * boss.respawnInterval;
                        state.bosses[boss.id] = { warningTime: 5 * 60 * 1000, soundStyle: 'classic', muted: false, nextRespawn: nextRespawn };
                    }
                });
                saveState();
            }

            function saveState() {
                localStorage.setItem('bossTrackerState', JSON.stringify(state));
            }

            // --- UI INITIALIZATION ---
            function initializeUI() {
                const settingsContainer = document.getElementById('boss-settings-container');
                const timersContainer = document.getElementById('boss-timers-container');
                const resetsContainer = document.getElementById('resets-container');
                const serverStatusContainer = document.getElementById('server-status-container');

                settingsContainer.innerHTML = '';
                timersContainer.innerHTML = '';
                resetsContainer.innerHTML = '';
                serverStatusContainer.innerHTML = '';

                // 1. Render Boss Timers
                bosses.forEach(boss => {
                    const bossState = state.bosses[boss.id];

                    const timerCard = document.createElement('div');
                    timerCard.className = 'glass-card rounded-xl p-6 flex flex-col relative overflow-hidden group';
                    timerCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4 z-10">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg ${boss.bg} ${boss.color} flex items-center justify-center text-xl shadow-inner">
                                    ${boss.icon}
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold text-white leading-tight">${boss.name}</h2>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">${boss.full_name}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span id="next-ready-label-${boss.id}" class="block text-[10px] text-gray-500 font-bold uppercase tracking-wider">Next Spawn</span>
                                <span id="next-ready-${boss.id}" class="text-xs font-mono text-accent-blue">Calculating...</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-center gap-2 mb-6 z-10 py-2">
                            <div class="flex flex-col items-center">
                                <div id="hours-${boss.id}" class="digit-box w-14 h-16 rounded-md flex items-center justify-center text-3xl font-mono font-bold text-white tracking-widest">00</div>
                                <span class="text-[10px] text-gray-500 mt-1 font-bold">HRS</span>
                            </div>
                            <span class="text-2xl text-gray-600 font-mono pb-4">:</span>
                            <div class="flex flex-col items-center">
                                <div id="minutes-${boss.id}" class="digit-box w-14 h-16 rounded-md flex items-center justify-center text-3xl font-mono font-bold text-white tracking-widest">00</div>
                                <span class="text-[10px] text-gray-500 mt-1 font-bold">MIN</span>
                            </div>
                            <span class="text-2xl text-gray-600 font-mono pb-4">:</span>
                            <div class="flex flex-col items-center">
                                <div id="seconds-${boss.id}" class="digit-box w-14 h-16 rounded-md flex items-center justify-center text-3xl font-mono font-bold text-white tracking-widest">00</div>
                                <span class="text-[10px] text-gray-500 mt-1 font-bold">SEC</span>
                            </div>
                        </div>

                        <div class="mt-auto z-10 bg-black/20 rounded-lg p-2 flex justify-between items-center">
                             <span id="notification-summary-${boss.id}" class="text-[10px] font-semibold text-gray-400 px-2">
                                Loading config...
                             </span>
                             <div class="h-2 w-2 rounded-full bg-gray-700" id="active-dot-${boss.id}"></div>
                        </div>
                        
                        <!-- Decor -->
                        <div class="absolute -right-10 -bottom-10 opacity-5 transform rotate-12 text-9xl pointer-events-none transition-opacity group-hover:opacity-10">
                            ${boss.icon}
                        </div>
                    `;
                    timersContainer.appendChild(timerCard);

                    // 2. Render Settings Row (Compact)
                    const settingsRow = document.createElement('div');
                    settingsRow.className = 'p-2 rounded hover:bg-white/5 transition-colors border border-transparent hover:border-white/5 mb-1';
                    settingsRow.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="${boss.color}">${boss.icon}</span>
                                <span class="text-xs font-semibold text-gray-300">${boss.name}</span>
                            </div>
                            <label class="switch scale-75 origin-right">
                                <input type="checkbox" id="mute-${boss.id}" ${bossState.muted ? '' : 'checked'}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="warning-time-${boss.id}" data-id="${boss.id}" class="warning-time-select w-full bg-black/30 border border-white/10 rounded text-[10px] text-gray-300 py-1 px-2 focus:border-accent-blue outline-none">
                                <option value="60000">Warn: 1m</option>
                                <option value="300000">Warn: 5m</option>
                                <option value="600000">Warn: 10m</option>
                            </select>
                            <select id="sound-style-${boss.id}" data-id="${boss.id}" class="sound-style-select w-full bg-black/30 border border-white/10 rounded text-[10px] text-gray-300 py-1 px-2 focus:border-accent-blue outline-none">
                                ${Object.keys(soundStyles).map(key => `<option value="${key}">${soundStyles[key].name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                    settingsContainer.appendChild(settingsRow);

                    // Set init values
                    document.getElementById(`warning-time-${boss.id}`).value = bossState.warningTime;
                    document.getElementById(`sound-style-${boss.id}`).value = bossState.soundStyle;
                });

                // 3. Render Resets
                // Daily
                const dailyDiv = document.createElement('div');
                dailyDiv.className = 'mb-6 border-b border-white/5 pb-4';
                dailyDiv.innerHTML = `
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-gray-400">DAILY</span>
                        <span id="daily-reset-time" class="text-[10px] text-gray-500 font-mono">...</span>
                    </div>
                    <div id="daily-reset-timer" class="text-2xl font-mono font-bold text-white mb-2 tracking-tight">--:--:--</div>
                    <ul class="space-y-1">
                        ${dailyResets.map(r => `<li class="text-xs text-gray-400 flex items-center gap-2"><i class="ph-fill ph-check-circle text-gray-600"></i> ${r.name}</li>`).join('')}
                    </ul>
                `;
                resetsContainer.appendChild(dailyDiv);

                // Weekly
                const weeklyDiv = document.createElement('div');
                weeklyDiv.innerHTML = `
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-gray-400">WEEKLY</span>
                        <span id="weekly-reset-time" class="text-[10px] text-gray-500 font-mono">...</span>
                    </div>
                    <div id="weekly-reset-timer" class="text-2xl font-mono font-bold text-accent-gold mb-2 tracking-tight">--:--:--</div>
                    <ul class="space-y-1">
                        ${weeklyResets.map(r => `<li class="text-xs text-gray-400 flex items-center gap-2"><i class="ph-fill ph-star text-accent-gold"></i> ${r.name}</li>`).join('')}
                    </ul>
                `;
                resetsContainer.appendChild(weeklyDiv);

                // 4. Server Status (Pills)
                servers.forEach(server => {
                    const pill = document.createElement('div');
                    pill.className = 'flex items-center gap-2 bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-lg transition-colors border border-white/5';
                    pill.innerHTML = `
                        <span id="status-dot-${server.id}" class="status-dot status-checking"></span>
                        <div class="flex flex-col leading-none">
                            <span class="text-xs font-bold text-gray-200">${server.name}</span>
                            <span id="status-text-${server.id}" class="text-[10px] text-gray-500 uppercase">Checking</span>
                        </div>
                    `;
                    serverStatusContainer.appendChild(pill);
                });

                // Global Inputs
                document.getElementById('sound-duration').value = state.soundDuration;
                updateNotificationButton();
                updateAllNotificationSummaries();
            }

            // --- EVENT LISTENERS ---
            function addEventListeners() {
                document.getElementById('notifications-btn').addEventListener('click', toggleNotifications);
                document.getElementById('sound-duration').addEventListener('change', (e) => {
                    state.soundDuration = parseInt(e.target.value);
                    saveState();
                    updateAllNotificationSummaries();
                });
                document.getElementById('swap-wallpaper-btn').addEventListener('click', swapWallpaper);

                document.querySelectorAll('.warning-time-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const bossId = e.target.dataset.id;
                        state.bosses[bossId].warningTime = parseInt(e.target.value);
                        saveState();
                        const bossToUpdate = bosses.find(b => b.id === bossId);
                        if (bossToUpdate) updateNotificationSummary(bossToUpdate);
                    });
                });
                document.querySelectorAll('.sound-style-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const bossId = e.target.dataset.id;
                        state.bosses[bossId].soundStyle = e.target.value;
                        saveState();
                    });
                });
                document.querySelectorAll('[id^="mute-"]').forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        const bossId = e.target.id.replace('mute-', '');
                        state.bosses[bossId].muted = !e.target.checked;
                        saveState();
                        const bossToUpdate = bosses.find(b => b.id === bossId);
                        if (bossToUpdate) updateNotificationSummary(bossToUpdate);
                    });
                });
            }

            // --- CORE LOGIC (Timers & Status) ---
            function updateAllTimers() {
                updateBossTimers();
                updateResetTimers();
            }

            function updateBossTimers() {
                const now = Date.now();
                bosses.forEach(boss => {
                    let bossState = state.bosses[boss.id];
                    let nextRespawnTime = bossState.nextRespawn;

                    // Rollover logic
                    if (now >= nextRespawnTime) {
                        while (nextRespawnTime < now) { nextRespawnTime += boss.respawnInterval; }
                        state.bosses[boss.id].nextRespawn = nextRespawnTime;
                        saveState();
                    }

                    const timeLeft = nextRespawnTime - now;
                    const hours = Math.floor(timeLeft / 3600000);
                    const minutes = Math.floor((timeLeft % 3600000) / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);

                    // Update Digits
                    document.getElementById(`hours-${boss.id}`).textContent = String(hours).padStart(2, '0');
                    document.getElementById(`minutes-${boss.id}`).textContent = String(minutes).padStart(2, '0');
                    document.getElementById(`seconds-${boss.id}`).textContent = String(seconds).padStart(2, '0');

                    // Next Ready Text
                    const nextReadyDate = new Date(nextRespawnTime);
                    const today = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(today.getDate() + 1);
                    let dayString = '';
                    if (nextReadyDate.getDate() === today.getDate()) dayString = 'Today';
                    else if (nextReadyDate.getDate() === tomorrow.getDate()) dayString = 'Tmrw';
                    else dayString = nextReadyDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });

                    document.getElementById(`next-ready-${boss.id}`).textContent = `${dayString} @ ${nextReadyDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

                    // Status Dot & Notifications
                    const activeDot = document.getElementById(`active-dot-${boss.id}`);

                    if (!bossState.muted && !notifiedFor[boss.id] && timeLeft <= bossState.warningTime && timeLeft > bossState.warningTime - 1000) {
                        triggerNotification(boss);
                        notifiedFor[boss.id] = true;
                    }

                    if (timeLeft > bossState.warningTime) {
                        notifiedFor[boss.id] = false;
                        activeDot.className = 'h-2 w-2 rounded-full bg-gray-600'; // Idle
                    } else {
                        activeDot.className = 'h-2 w-2 rounded-full bg-accent-gold animate-pulse'; // Warning zone
                    }
                });
            }

            function updateResetTimers() {
                const now = new Date();
                const resetHourUTC = 20;

                // Daily
                let nextDailyReset = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), resetHourUTC, 0, 0, 0));
                if (now.getTime() >= nextDailyReset.getTime()) {
                    nextDailyReset.setUTCDate(nextDailyReset.getUTCDate() + 1);
                }
                document.getElementById('daily-reset-timer').textContent = formatTimeLeft(nextDailyReset.getTime() - now.getTime());
                document.getElementById('daily-reset-time').textContent = nextDailyReset.toLocaleString([], { weekday: 'short', hour: '2-digit', minute: '2-digit' });

                // Weekly
                let nextWeeklyReset = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), resetHourUTC, 0, 0, 0));
                const currentUTCDay = now.getUTCDay();
                const daysUntilMonday = (1 - currentUTCDay + 7) % 7;
                nextWeeklyReset.setUTCDate(nextWeeklyReset.getUTCDate() + daysUntilMonday);
                if (daysUntilMonday === 0 && now.getTime() >= nextWeeklyReset.getTime()) {
                    nextWeeklyReset.setUTCDate(nextWeeklyReset.getUTCDate() + 7);
                }
                document.getElementById('weekly-reset-timer').textContent = formatTimeLeft(nextWeeklyReset.getTime() - now.getTime());
                document.getElementById('weekly-reset-time').textContent = nextWeeklyReset.toLocaleString([], { weekday: 'short', hour: '2-digit', minute: '2-digit' });
            }

            async function pingServer(server) {
                const dot = document.getElementById(`status-dot-${server.id}`);
                const text = document.getElementById(`status-text-${server.id}`);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                try {
                    await fetch(`http://${server.ip}:${server.port}`, { method: 'GET', mode: 'no-cors', signal: controller.signal });
                    // If no network error, assume online (opaque response due to no-cors)
                    dot.className = 'status-dot status-online';
                    text.textContent = 'Online';
                    text.className = 'text-[10px] text-accent-green uppercase font-bold';
                } catch (e) {
                    if (e.name === 'AbortError') {
                        dot.className = 'status-dot status-offline';
                        text.textContent = 'Timeout';
                        text.className = 'text-[10px] text-accent-red uppercase font-bold';
                    } else if (e instanceof TypeError) {
                        // CORS error usually means server is up but rejecting browser origin
                        dot.className = 'status-dot status-online';
                        text.textContent = 'Online';
                        text.className = 'text-[10px] text-accent-green uppercase font-bold';
                    } else {
                        dot.className = 'status-dot status-offline';
                        text.textContent = 'Offline';
                        text.className = 'text-[10px] text-accent-red uppercase font-bold';
                    }
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            function updateServerStatus() {
                servers.forEach(pingServer);
            }

            // --- NOTIFICATIONS & AUDIO ---
            function triggerNotification(boss) {
                const bossState = state.bosses[boss.id];
                const warningTimeMinutes = bossState.warningTime / 60000;
                const message = `${boss.name} is spawning in ${warningTimeMinutes} minute${warningTimeMinutes > 1 ? 's' : ''}!`;
                playSound(boss.id, 'warning');
                if (state.notificationsEnabled && Notification.permission === 'granted') {
                    new Notification('Boss Alert!', { body: message, icon: 'https://placehold.co/128x128/111827/FFFFFF?text=!' });
                }
            }

            function playSound(bossId, type) {
                Tone.start();
                const bossState = state.bosses[bossId]; // Fixed access
                const synth = soundStyles[bossState.soundStyle].synth;
                const duration = state.soundDuration;

                if (type === 'warning') {
                    if (bossState.soundStyle === 'roar') synth.triggerAttackRelease("8n", duration);
                    else {
                        const now = Tone.now();
                        synth.triggerAttackRelease('C4', '8n', now);
                        synth.triggerAttackRelease('G4', '8n', now + 0.5);
                        if (duration > 5) synth.triggerAttackRelease('C5', '8n', now + 1.0);
                    }
                }
            }

            function formatTimeLeft(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const days = Math.floor(totalSeconds / 86400);
                const hours = Math.floor((totalSeconds % 86400) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                let parts = [];
                if (days > 0) parts.push(`${days}d`);
                parts.push(`${String(hours).padStart(2, '0')}h`);
                parts.push(`${String(minutes).padStart(2, '0')}m`);
                parts.push(`${String(seconds).padStart(2, '0')}s`);
                return parts.join(' ');
            }

            function updateNotificationSummary(boss) {
                const bossState = state.bosses[boss.id];
                const warningTimeMins = bossState.warningTime / 60000;
                const summaryEl = document.getElementById(`notification-summary-${boss.id}`);
                if (bossState.muted) {
                    summaryEl.textContent = 'MUTED';
                    summaryEl.className = 'text-[10px] font-bold text-gray-600 px-2 border border-gray-700 rounded';
                } else {
                    summaryEl.textContent = `WARN: ${warningTimeMins}m â€¢ AUDIO: ${state.soundDuration}s`;
                    summaryEl.className = 'text-[10px] font-bold text-accent-blue px-2 border border-accent-blue/30 rounded bg-accent-blue/10';
                }
            }

            function updateAllNotificationSummaries() {
                bosses.forEach(boss => updateNotificationSummary(boss));
            }

            function updateNotificationButton() {
                const btn = document.getElementById('notifications-btn');
                const text = document.getElementById('notif-text');
                const icon = btn.querySelector('i');

                if (state.notificationsEnabled) {
                    text.textContent = 'Alerts On';
                    text.className = 'text-accent-green';
                    icon.className = 'ph-fill ph-bell-ringing text-lg text-accent-green';
                    btn.querySelector('div').className = 'p-1.5 rounded-full bg-accent-green/10';
                } else {
                    text.textContent = 'Alerts Off';
                    text.className = 'text-gray-400 group-hover:text-white';
                    icon.className = 'ph-duotone ph-bell-slash text-lg';
                    btn.querySelector('div').className = 'p-1.5 rounded-full bg-white/5 group-hover:bg-white/10';
                }
            }

            function toggleNotifications() {
                if (!state.notificationsEnabled) {
                    if (Notification.permission === 'granted') {
                        state.notificationsEnabled = true;
                        saveState();
                        updateNotificationButton();
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                state.notificationsEnabled = true;
                                saveState();
                                updateNotificationButton();
                                new Notification('Notifications Enabled!', { body: 'You will now receive boss alerts.' });
                            }
                        });
                    } else {
                        const text = document.getElementById('notif-text');
                        text.textContent = 'Blocked!';
                        text.className = 'text-accent-red';
                        setTimeout(() => updateNotificationButton(), 3000);
                    }
                } else {
                    state.notificationsEnabled = false;
                    saveState();
                    updateNotificationButton();
                }
            }

            // --- INIT ---
            loadState();
            initializeUI();
            addEventListeners();
            setInterval(updateAllTimers, 1000);
            updateAllTimers();
            updateServerStatus();
            setInterval(updateServerStatus, 60000);
        });
    </script>
</body>

</html>